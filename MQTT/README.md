# MQTT


## Возможности

* Мониторинг данных с фотодатчика: Система способна непрерывно получать данные с фотодатчика, подключенного через последовательный порт. Это включает в себя как мгновенные значения, так и вычисленные параметры, такие как скользящее среднее, минимум и максимум.

* Публикация данных через MQTT: Полученные данные с фотодатчика публикуются в облако через MQTT-брокер, что позволяет передавать информацию другим системам или приложениям. Различные типы данных публикуются в отдельные топики (например, мгновенные значения, средние значения, минимальное и максимальное значения, и данные потоковой передачи).

* Управление внешним устройством (светодиодом): Система способна управлять внешним устройством, например, светодиодом, подключенным через последовательный порт. Управление осуществляется на основе данных, полученных с фотодатчика и определенного алгоритма.

* Обработка данных (скользящее среднее, обнаружение тренда): Система выполняет обработку данных, включая расчет скользящего среднего значения для сглаживания шума и обнаружение возрастающего или убывающего тренда. Эти вычисления используются для принятия решений об управлении внешним устройством.

* Потоковая передача данных: Система поддерживает потоковую передачу данных с фотодатчика, предоставляя возможность получать информацию в реальном времени. Включение и выключение потоковой передачи может осуществляться пользователем.



## Команды (передаются автоматически из скрипта python)
- **'p'**: Получение значения освещенности.
- **'u'**: Включение сигнала.
- **'d'**: Выключение сигнала.

## Описание программы **arduino**
Данная программа реализует управление светодиодом на основе полученных данных от датчика освещенности.  

### Функционал:

* Прием команд: Программа ожидает команд, отправленных по COM-порту с компьютера. 
* Управление светодиодом:
    * Команда `'u'` включает светодиод.
    * Команда `'d'` выключает светодиод.
* Считывание данных от датчика:
    * Команда `'p'` заставляет программу считать данные от датчика освещенности (подключенного к аналоговому пину `A0`) и отправить их обратно на компьютер.
    * Данные считываются через функцию `analogRead`, затем сжимаются (деление на 4) для экономии трафика и отправляются в виде байта. 

### Описание кода:

* **#define:**

  Задаются константы для пинов светодиода (`PIN_LED_1`), датчика освещенности (`PIN_PHOTO_SENSOR_1`) и команд (`SET_ON`, `SET_OFF`, `SET_PHOTO`).

* **pause:**

  Функция, которая вводит паузу в выполнение программы на заданное время (в миллисекундах). 

* **getting_command:**

  Функция, которая считывает команды с USB-порта и выполняет соответствующие действия. 

* **setup:**

  Функция, которая выполняется только один раз при запуске программы. В ней инициализируется последовательный порт и устанавливается пин светодиода в режим вывода.

* **loop:**

  Функция, которая выполняется в цикле бесконечно. В ней вызывается функция `getting_command` для обработки команд с компьютера.

### Работа программы:

1. Программа устанавливает связь через COM-порт.
2. Ожидает команды с компьютера.
3. При получении команды `'u'`, `'d'` или `'p'`, программа выполняет соответствующее действие: включение/выключение светодиода или считывание данных от датчика.
4. Считанные от датчика данные отправляются обратно на компьютер ЛИБО происходит включение/выключение светодиода. 





## Описание программ **python**

### subscriber.py


#### **Функционал:**

Программа осуществляет мониторинг данных с фотодатчика и управляет светодиодом на основе полученных значений. Данные с фотодатчика поступают через MQTT-брокер, а управление светодиодом происходит через последовательный порт. Система обрабатывает мгновенные значения, средние значения (скользящее среднее), минимальное и максимальное значения, определяя тренд изменений для принятия решений об управлении светодиодом.


#### **Описание кода:**

Код использует библиотеки `serial`, `uuid`, `hashlib`, `time` и `paho.mqtt.client` для взаимодействия с последовательным портом, генерации уникальных идентификаторов, работы со временем и обмена сообщениями через MQTT-брокер соответственно. Ключевые компоненты кода:

1. Функции:
    * `calculate_moving_average(data_list)`: Вычисляет скользящее среднее значение из списка данных, используя окно размером `window_size` (5 по умолчанию). Возвращает `None`, если длина списка меньше размера окна.
    * `send_command(cmd, response_len, connection)`: Отправляет команду (`cmd`) по последовательному порту и получает ответ длиной `response_len`. Обработка ответа зависит от команды: для команды 'p' (чтение данных с фотодатчика) ответ интерпретируется как целое число, умноженное на 4.
    * `detect_trend(data_list)`: Анализирует последние 5 значений в списке и определяет, является ли тренд возрастающим или убывающим.
    * `on_message(client, userdata, message)`: Обработчик входящих MQTT-сообщений. В зависимости от темы сообщения обрабатывает мгновенные значения, средние значения, поток данных, минимальное и максимальное значения. При обработке потока данных (`lab/{pub_id}/photo/stream`), управляет светодиодом через последовательный порт (`connection_led`), используя команды 'u' (включить) и 'd' (выключить), основываясь на текущем значении и определенном тренде.

2. Инициализация: Устанавливаются параметры соединения с последовательным портом (`port_led`, `connection_led`), MQTT-брокером (`broker`), генерируются уникальные идентификаторы (`sub_id`, `pub_id`) на основе MAC-адреса, инициализируются переменные для хранения данных и параметров.

3. MQTT-подключение и подписка: Создается MQTT-клиент, устанавливается обработчик сообщений `on_message`, устанавливается соединение с брокером и происходит подписка на несколько тем, связанных с данными фотодатчика и управлением светодиодом.

4. Основной цикл: После подключения к MQTT-брокеру, программа ожидает входящие сообщения в течение заданного времени (`time.sleep(18100)` - 5 часов), после чего завершается.


#### **Работа программы:**

Программа запускается, устанавливая соединение с MQTT-брокером и последовательным портом. Она подписывается на различные MQTT-топики, ожидая данные с фотодатчика. Когда поступают данные, они обрабатываются функцией `on_message`. Эта функция обрабатывает различные типы данных: мгновенные значения, средние значения, данные потока и минимальное/максимальное значения. Для потоковых данных определяется тренд, и на основе этого тренда и текущего значения, отправляются команды на управление светодиодом через последовательный порт. Программа работает в течение 5 часов, после чего завершается. Минимальное и максимальное значения постоянно обновляются и передаются через MQTT. Система работает на основе событий, реагируя на поступающие данные с фотодатчика через MQTT-брокер.


### publisher.py

#### **Функционал:**

Программа выполняет непрерывный мониторинг данных с фотодатчика, подключенного через последовательный порт, и публикует эти данные в облако через MQTT-брокер. Система предоставляет три типа данных: мгновенные значения, скользящее среднее и информацию о минимальном и максимальном значениях. Дополнительно реализована функция потоковой передачи данных, управляемая пользователем через консольный ввод.


#### **Описание кода:**

Код написан на Python и использует несколько библиотек: `datetime`, `time`, `uuid`, `serial`, `paho.mqtt.client`, `random`, `hashlib`, `collections.deque`, и `threading`. Он выполняет следующие действия:

1. Инициализация: Программа устанавливает соединение с MQTT-брокером (`broker.emqx.io`) и последовательным портом (`COM8`), используя библиотеку `serial`. Генерируется уникальный идентификатор (`pub_id`) для публикации данных в MQTT, основанный на MAC-адресе компьютера, используя библиотеки `uuid` и `hashlib`. Инициализируются переменные для хранения минимального и максимального значений, очереди для скользящего среднего (`averaging_queue`), флаги для управления потоковой передачей (`streaming_on`, `last_stream_on`), а также интервалы для публикации данных (`averaging_interval`, `streaming_interval`).

2. Функция `send_command`: Эта функция отправляет команду на устройство, подключенное к последовательному порту, и принимает ответ. Обработка ответа зависит от команды: для команды 'p' (получение данных с фотодатчика) ответ интерпретируется как целое число.

3. Основной цикл: Программа работает в бесконечном цикле (`while True`). В каждой итерации:
    * Считываются данные с фотодатчика через функцию `send_command`.
    * Публикуются мгновенные значения в MQTT-топик `lab/{pub_id}/photo/instant`.
    * Данные добавляются в очередь `averaging_queue` для расчета скользящего среднего.
    * Если очередь заполнена, вычисляется и публикуется скользящее среднее в топик `lab/{pub_id}/photo/average`.
    * Отслеживаются минимальное и максимальное значения. Они публикуются в топики `lab/{pub_id}/photo/min` и `lab/{pub_id}/photo/max` каждые 5 итераций.
    * Управление потоковой передачей: если `streaming_on` истинно и состояние изменилось, запускается отдельный поток (`stream_thread`) для публикации данных в топик `lab/{pub_id}/photo/stream` с заданной частотой. Если `streaming_on` ложно, поток завершается.
    * Обработка консольного ввода: отдельный поток (`on_off_thread`) ожидает ввод пользователя ("on" или "off") для управления потоковой передачей.

4. Потоки: Используются потоки (`threading.Thread`) для параллельной обработки: один поток для потоковой передачи данных (`stream_thread`) и один для обработки консольного ввода (`on_off_thread`). Это позволяет программе одновременно получать данные с датчика, обрабатывать их и реагировать на команды пользователя без блокировки.

5. Завершение: Программа завершается принудительно после отключения от MQTT-брокера (`client.disconnect()` и `client.loop_stop()`), хотя в коде нет явного механизма остановки.


#### **Работа программы:**

Программа устанавливает постоянное соединение с MQTT-брокером и последовательным портом. Она непрерывно считывает данные с фотодатчика, обрабатывает их (вычисляет среднее, отслеживает минимум и максимум) и публикует в соответствующие MQTT-топики. Потоковая передача данных включается и выключается пользователем через консольный ввод, что управляет отдельным потоком, который публикует данные с высокой частотой. Программа работает до тех пор, пока не будет принудительно остановлена. Использование потоков позволяет обрабатывать данные и реагировать на команды пользователя без задержек.


